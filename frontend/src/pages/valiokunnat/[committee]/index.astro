---
import { committeeData } from "./_utils";
import { db } from "~src/database";
import { sql } from "kysely";
import BaseLayout from "~src/layouts/BaseLayout.astro";
import MpRoundPhoto from "~src/components/MpRoundPhoto.astro";

export const getStaticPaths = committeeData;

const { committee } = Astro.props;

const committee_members = committee
    ? await db
          // start from persons, pick at most one committee membership per person (latest start_date)
          .selectFrom("persons")
          .leftJoinLateral(
              (eb) =>
                  eb
                      .selectFrom("mp_committee_memberships as mcm")
                      .select(["mcm.start_date", "mcm.end_date", "mcm.role"])
                      .where("mcm.committee_name", "=", committee.name)
                      .where("mcm.end_date", "is", null)
                      .whereRef("mcm.person_id", "=", "persons.id")
                      .orderBy("mcm.start_date", (ob) => ob.desc().nullsLast())
                      .limit(1)
                      .as("membership"),
              (join) => join.onTrue(),
          )
          .leftJoinLateral(
              (eb) =>
                  eb
                      .selectFrom("mp_parliamentary_group_memberships as mppm")
                      .select([
                          "mppm.pg_id",
                          "mppm.start_date",
                          "mppm.end_date",
                      ])
                      .whereRef("mppm.person_id", "=", "persons.id")
                      .orderBy("mppm.start_date", (ob) => ob.desc().nullsLast())
                      .limit(1)
                      .as("parliamentary_group"),
              (join) => join.onTrue(),
          )
          // only keep persons that actually have a current membership in this committee
          .where("membership.start_date", "is not", null)
          // group members by role and aggregate member objects into a JSON array
          .select([
              "membership.role as role",
              sql`json_agg(json_build_object(
                  'first_name', persons.first_name,
                  'last_name', persons.last_name,
                  'photo', persons.photo,
                  'pg_id', parliamentary_group.pg_id,
                  'start_date', membership.start_date,
                  'end_date', membership.end_date
              ) ORDER BY membership.start_date DESC)`.as("members"),
          ])
          .groupBy("membership.role")
          .execute()
    : [];
---

<BaseLayout committee={committee}>
    <section>
        <h1>{committee.name}</h1>

        <section>
            <h4>JÃ¤senet</h4>
            <div class="boardContainer">
                {
                    committee_members.map((group) => (
                        <div>
                            <h4>{group.role}</h4>
                            {(group.members || []).map((member) => (
                                <div class="member">
                                    <MpRoundPhoto
                                        mp={{
                                            first_name: member.first_name,
                                            last_name: member.last_name,
                                            photo: member.photo,
                                            party_id: member.pg_id,
                                        }}
                                    />
                                </div>
                            ))}
                        </div>
                    ))
                }
            </div>
        </section>
    </section>
</BaseLayout>

<style>
    .boardContainer {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        height: 500px;
    }
    .boardContainer > div {
        margin: 1rem;
        text-align: center;
    }
</style>
